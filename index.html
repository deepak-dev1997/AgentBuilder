<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent‚ÄëBuilder Admin</title>

    <!-- ===== BASIC RESET & THEME ===== -->
    <style>
        :root {
            --accent:#0066ff;
            --accent-light:#eaf1ff;
            --danger:#d90429;
            --radius:10px;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
        body{padding:24px;background:#f7f9fc;color:#222}
        h1{margin-bottom:16px;font-size:1.8rem;color:var(--accent)}
        button,select,input,textarea{padding:6px 10px;border:1px solid #ccc;border-radius:var(--radius);font:inherit}
        button{cursor:pointer;background:var(--accent);color:#fff;border:none;transition:background .2s}
        button:hover{background:#004ec4}
        nav{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
        nav button{background:var(--accent-light);color:var(--accent);font-weight:500}
        nav button.active{background:var(--accent);color:#fff}
        .tab{display:none}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{border:1px solid #ddd;padding:8px;text-align:left}
        th{background:#eef2f7}
        .actions button{margin-right:6px}
        .danger{background:var(--danger)!important}
        /* === Modal === */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:999}
        .modal .card{background:#fff;width:96%;max-width:500px;padding:20px;border-radius:var(--radius);box-shadow:0 6px 16px rgba(0,0,0,.15)}
        .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .modal header h2{font-size:1.25rem}
        .close{background:none;color:#666;font-size:1.2rem;border:none}
        .field{margin-bottom:10px;display:flex;flex-direction:column}
        .field label{margin-bottom:4px;font-weight:500}
        .field textarea{min-height:70px;resize:vertical;font:inherit}
        @media(max-width:500px){body{padding:12px}nav button{flex:1}}
    </style>
</head>
<body>
<h1>Agent‚ÄëBuilder Admin</h1>

<!-- ========= NAV ========= -->
<nav>
    <button id="tabBtn-bots"   onclick="showTab('botsTab')"   class="active">Bots</button>
    <button id="tabBtn-llm"    onclick="showTab('llmTab')"   >LLM Config</button>
    <button id="tabBtn-prompt" onclick="showTab('promptTab')">Prompt Config</button>
    <button id="tabBtn-tools"  onclick="showTab('toolsTab')" >Tools</button>
    <button id="tabBtn-kb"     onclick="showTab('kbTab')"    >Knowledge¬†Base</button>
</nav>

<!-- ========= BOTS TAB ========= -->
<section id="botsTab" class="tab" style="display:block">
    <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Bots</h2>
        <button onclick="openBotModal()">‚ûï  New Bot</button>
    </div>
    <table id="botsTable">
        <thead><tr><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
        <tbody></tbody>
    </table>
</section>

<!-- ========= LLM CONFIG TAB ========= -->
<section id="llmTab" class="tab">
    <h2>LLM Configuration</h2>
    <div class="field">
        <label for="llmBotSelect">Select Bot</label>
        <select id="llmBotSelect" onchange="loadLlmConfig()"></select>
    </div>

    <div id="llmFormWrapper" style="display:none">
        <div class="field"><label>Model</label><input id="llmModel"></div>
        <div class="field"><label>Temperature</label><input type="number" step="0.01" id="llmTemp"></div>
        <div class="field"><label>Max Tokens</label><input type="number" id="llmMax"></div>
        <button onclick="saveLlm()">üíæ Save</button>
        <button class="danger" onclick="deleteLlm()">üóëÔ∏è Delete</button>
    </div>
</section>

<!-- ========= PROMPT CONFIG TAB ========= -->
<section id="promptTab" class="tab">
    <h2>Prompt Configuration</h2>
    <div class="field">
        <label for="promptBotSelect">Select Bot</label>
        <select id="promptBotSelect" onchange="loadPromptConfig()"></select>
    </div>

    <div id="promptFormWrapper" style="display:none">
        <div class="field"><label>Role</label><input id="promptRole"></div>
        <div class="field"><label>System Prompt</label><textarea id="promptSys"></textarea></div>
        <div class="field"><label>First Message</label><textarea id="promptFirst"></textarea></div>
        <button onclick="savePrompt()">üíæ Save</button>
        <button class="danger" onclick="deletePrompt()">üóëÔ∏è Delete</button>
    </div>
</section>

<!-- ========= TOOLS TAB ========= -->
<section id="toolsTab" class="tab">
    <h2>Tools</h2>
    <div class="field">
        <label for="toolsBotSelect">Select Bot</label>
        <select id="toolsBotSelect" onchange="loadToolsTable()"></select>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="selectedBotTitle"></h3>
        <button onclick="openToolModal()">‚ûï  New Tool</button>
    </div>

    <table id="toolsTable">
        <thead><tr><th>Name</th><th>Description</th><th>Server URL</th><th>Actions</th></tr></thead>
        <tbody></tbody>
    </table>
</section>

<!-- ========= KNOWLEDGE BASE TAB ========= -->
<section id="kbTab" class="tab">
    <h2>Knowledge¬†Base</h2>
    <div class="field"><label>Select Bot</label><select id="kbBotSelect" onchange="loadKbData()"></select></div>

    <!-- QnA section -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <h3 id="kbBotTitle"></h3>
        <button onclick="openQnaModal()">‚ûï¬†Add¬†QnA</button>
    </div>
    <table id="qnaTable"><thead><tr><th>#</th><th>Question</th><th>Answer</th><th>Actions</th></tr></thead><tbody></tbody></table>

    <!-- Files -->
    <h3 style="margin-top:20px">Files</h3>
    <div style="display:flex;gap:8px;align-items:center">
        <input type="file" id="kbFileInput">
        <button onclick="uploadKbFile()">‚¨ÜÔ∏è¬†Upload</button>
    </div>
    <table id="fileTable" style="margin-top:12px"><thead><tr><th>Name</th><th>Actions</th></tr></thead><tbody></tbody></table>
</section>

<!-- ========= BOT MODAL ========= -->
<div id="botModal" class="modal">
    <div class="card">
        <header><h2 id="botModalTitle">New Bot</h2><button class="close" onclick="closeBotModal()">‚úñ</button></header>
        <div class="field"><label>Name</label><input id="botNameInput"></div>
        <div class="field"><label>Description</label><textarea id="botDescInput"></textarea></div>
        <button onclick="saveBot()">üíæ Save</button>
    </div>
</div>

<!-- ========= TOOL MODAL ========= -->
<div id="toolModal" class="modal">
    <div class="card" style="max-width:600px">
        <header><h2 id="toolModalTitle">New Tool</h2><button class="close" onclick="closeToolModal()">‚úñ</button></header>
        <div class="field"><label>Name</label><input id="toolNameInput"></div>
        <div class="field"><label>Description</label><textarea id="toolDescInput"></textarea></div>
        <div class="field"><label>Server URL</label><input id="toolUrlInput"></div>
        <div class="field"><label>Headers (JSON)</label><textarea id="toolHeadersInput"></textarea></div>
        <div class="field"><label>Parameters (JSON)</label><textarea id="toolParamsInput"></textarea></div>
        <div class="field"><label>Request Body (JSON)</label><textarea id="toolBodyInput"></textarea></div>
        <div class="field"><label>Before Tool</label><input id="toolBeforeInput"></div>
        <div class="field"><label>After Tool</label><input id="toolAfterInput"></div>
        <button onclick="saveTool()">üíæ Save</button>
    </div>
</div>
<!-- ========= QNA MODAL ========= -->
<div id="qnaModal" class="modal"><div class="card"><header><h2 id="qnaModalTitle">New¬†QnA</h2><button class="close" onclick="closeQnaModal()">‚úñ</button></header><div class="field"><label>Question</label><textarea id="qnaQuestion"></textarea></div><div class="field"><label>Answer</label><textarea id="qnaAnswer"></textarea></div><button onclick="saveQna()">üíæ¬†Save</button></div></div>


<!-- ========= MAIN JS ========= -->
<script>
const baseUrl = "http://localhost:8081"; // TODO: change if backend runs elsewhere
let bots = [];
let currentBot = null;              // for editing bot
let editMode = false;               // bot modal state
let currentTool = null;             // for editing tool

/* ------ BASIC HELPERS ------ */
function showTab(tabId){
    document.querySelectorAll('nav button').forEach(btn=>btn.classList.remove('active'));
    document.getElementById('tabBtn-'+tabId.replace('Tab','')).classList.add('active');
    document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
    document.getElementById(tabId).style.display='block';
    if(tabId==='botsTab')loadBots();
    if(tabId==='kbTab')loadKbData();
}
function openBotModal(bot){
    document.getElementById('botModal').style.display='flex';
    if(bot){
        editMode=true;
        currentBot = bot;
        document.getElementById('botModalTitle').textContent='Edit Bot';
        document.getElementById('botNameInput').value=bot.botName;
        document.getElementById('botNameInput').disabled=true; // id immutable
        document.getElementById('botDescInput').value=bot.botDescription;
    }else{
        editMode=false;
        currentBot=null;
        document.getElementById('botModalTitle').textContent='New Bot';
        document.getElementById('botNameInput').disabled=false;
        document.getElementById('botNameInput').value='';
        document.getElementById('botDescInput').value='';
    }
}
function closeBotModal(){document.getElementById('botModal').style.display='none'}
function openToolModal(tool){
    if(!document.getElementById('toolsBotSelect').value){alert('Select a bot first');return;}
    document.getElementById('toolModal').style.display='flex';
    if(tool){
        currentTool=tool;
        editMode=true;
        document.getElementById('toolModalTitle').textContent='Edit Tool';
        document.getElementById('toolNameInput').value=tool.toolName;
        document.getElementById('toolNameInput').disabled=true;
        document.getElementById('toolDescInput').value=tool.description||'';
        document.getElementById('toolUrlInput').value=tool.serverUrl||'';
        document.getElementById('toolHeadersInput').value=JSON.stringify(tool.headers||{},null,2);
        document.getElementById('toolParamsInput').value=JSON.stringify(tool.parameters||{},null,2);
        document.getElementById('toolBodyInput').value=JSON.stringify(tool.requestBody||{},null,2);
        document.getElementById('toolBeforeInput').value=tool.beforeTool||'';
        document.getElementById('toolAfterInput').value=tool.afterTool||'';
    }else{
        editMode=false;
        currentTool=null;
        document.getElementById('toolModalTitle').textContent='New Tool';
        document.querySelectorAll('#toolModal input, #toolModal textarea').forEach(el=>{el.disabled=false;el.value=''});
    }
}
function closeToolModal(){document.getElementById('toolModal').style.display='none'}

/* ------ BOTS ------ */
async function loadBots(){
    const res = await fetch(baseUrl+'/api/bots');
    bots = await res.json();
    const tbody = document.querySelector('#botsTable tbody');
    tbody.innerHTML='';
    bots.forEach(b=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${b.botName}</td><td>${b.botDescription||''}</td><td class="actions"></td>`;
        const actions=tr.querySelector('.actions');
        const editBtn=document.createElement('button');editBtn.textContent='‚úèÔ∏è Edit';editBtn.onclick=()=>openBotModal(b);
        const delBtn=document.createElement('button');delBtn.textContent='üóëÔ∏è';delBtn.className='danger';delBtn.onclick=()=>deleteBot(b.botName);
        actions.append(editBtn,delBtn);
        tbody.appendChild(tr);
    });
    // Refresh dropdowns
    fillBotDropdown('llmBotSelect');
    fillBotDropdown('promptBotSelect');
    fillBotDropdown('toolsBotSelect');
    fillBotDropdown('kbBotSelect');
}
async function saveBot(){
    const name=document.getElementById('botNameInput').value.trim();
    const desc=document.getElementById('botDescInput').value.trim();
    if(!name){alert('Name required');return;}
    const dto={botName:name,botDescription:desc};
    const opts={headers:{'Content-Type':'application/json'},body:JSON.stringify(dto)};
    if(editMode){
        await fetch(`${baseUrl}/api/bots/${name}`,{method:'PUT',...opts});
    }else{
        await fetch(`${baseUrl}/api/bots`,{method:'POST',...opts});
    }
    closeBotModal();
    loadBots();
}
async function deleteBot(name){
    if(!confirm(`Delete bot "${name}"?`))return;
    await fetch(`${baseUrl}/api/bots/${name}`,{method:'DELETE'});
    loadBots();
}

/* ------ LLM CONFIG ------ */
function fillBotDropdown(id){
    const sel=document.getElementById(id);
    const current=sel.value;
    sel.innerHTML='<option value="">-- choose --</option>';
    bots.forEach(b=>{
        const opt=document.createElement('option');opt.value=b.botName;opt.textContent=b.botName;sel.appendChild(opt);
    });
    if(current) sel.value=current; // keep selection if possible
}
async function loadLlmConfig(){
    const botId=document.getElementById('llmBotSelect').value;
    const formWrap=document.getElementById('llmFormWrapper');
    if(!botId){formWrap.style.display='none';return;}
    const res=await fetch(`${baseUrl}/api/llm-configs/${botId}`);
    if(res.ok){
        const cfg=await res.json();
        document.getElementById('llmModel').value=cfg.model||'';
        document.getElementById('llmTemp').value=cfg.temperature||0.0;
        document.getElementById('llmMax').value=cfg.maxTokens||0;
    }else{
        document.getElementById('llmModel').value='';
        document.getElementById('llmTemp').value='';
        document.getElementById('llmMax').value='';
    }
    formWrap.style.display='block';
}
async function saveLlm(){
    const botId=document.getElementById('llmBotSelect').value;
    const dto={botId:botId,model:document.getElementById('llmModel').value.trim(),temperature:parseFloat(document.getElementById('llmTemp').value),maxTokens:parseInt(document.getElementById('llmMax').value)};
    const res=await fetch(`${baseUrl}/api/llm-configs/${botId}`);
    const method=res.ok?'PUT':'POST';
    await fetch(`${baseUrl}/api/llm-configs`+(method==='PUT'?`/${botId}`:''),{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(dto)});
    alert('Saved');
}
async function deleteLlm(){
    const botId=document.getElementById('llmBotSelect').value;
    if(!confirm('Delete LLM config?'))return;
    await fetch(`${baseUrl}/api/llm-configs/${botId}`,{method:'DELETE'});
    loadLlmConfig();
}

/* ------ PROMPT CONFIG ------ */
async function loadPromptConfig(){
    const botId=document.getElementById('promptBotSelect').value;
    const wrap=document.getElementById('promptFormWrapper');
    if(!botId){wrap.style.display='none';return;}
    const res=await fetch(`${baseUrl}/api/prompt-configs/${botId}`);
    if(res.ok){
        const cfg=await res.json();
        document.getElementById('promptRole').value=cfg.role||'';
        document.getElementById('promptSys').value=cfg.systemPrompt||'';
        document.getElementById('promptFirst').value=cfg.firstMessage||'';
    }else{
        document.getElementById('promptRole').value='';
        document.getElementById('promptSys').value='';
        document.getElementById('promptFirst').value='';
    }
    wrap.style.display='block';
}
async function savePrompt(){
    const botId=document.getElementById('promptBotSelect').value;
    const dto={botId,role:document.getElementById('promptRole').value.trim(),systemPrompt:document.getElementById('promptSys').value.trim(),firstMessage:document.getElementById('promptFirst').value.trim()};
    const res=await fetch(`${baseUrl}/api/prompt-configs/${botId}`);
    const method=res.ok?'PUT':'POST';
    await fetch(`${baseUrl}/api/prompt-configs`+(method==='PUT'?`/${botId}`:''),{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(dto)});
    alert('Saved');
}
async function deletePrompt(){
    const botId=document.getElementById('promptBotSelect').value;
    if(!confirm('Delete prompt config?'))return;
    await fetch(`${baseUrl}/api/prompt-configs/${botId}`,{method:'DELETE'});
    loadPromptConfig();
}

/* ------ TOOLS ------ */
async function loadToolsTable(){
    const botName=document.getElementById('toolsBotSelect').value;
    document.getElementById('selectedBotTitle').textContent=botName?`Bot: ${botName}`:'';
    const tbody=document.querySelector('#toolsTable tbody');
    tbody.innerHTML='';
    if(!botName)return;
    const res=await fetch(`${baseUrl}/api/bots/${botName}/tools`);
    if(!res.ok)return;
    const tools=await res.json();
    tools.forEach(t=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${t.toolName}</td><td>${t.description||''}</td><td>${t.serverUrl||''}</td><td class="actions"></td>`;
        const actions=tr.querySelector('.actions');
        const edit=document.createElement('button');edit.textContent='‚úèÔ∏è';edit.onclick=()=>openToolModal(t);
        const del=document.createElement('button');del.textContent='üóëÔ∏è';del.className='danger';del.onclick=()=>deleteTool(t.toolName);
        actions.append(edit,del);
        tbody.appendChild(tr);
    });
}
async function saveTool(){
    const botName=document.getElementById('toolsBotSelect').value;
    const name=document.getElementById('toolNameInput').value.trim();
    if(!name){alert('Tool name required');return;}
    const dto={
        toolName:name,
        description:document.getElementById('toolDescInput').value.trim(),
        serverUrl:document.getElementById('toolUrlInput').value.trim(),
        headers:jsonField('toolHeadersInput'),
        parameters:jsonField('toolParamsInput'),
        requestBody:jsonField('toolBodyInput'),
        beforeTool:document.getElementById('toolBeforeInput').value.trim(),
        afterTool:document.getElementById('toolAfterInput').value.trim()
    };
    const res=await fetch(`${baseUrl}/api/bots/${botName}/tools/${name}`);
    const method=res.ok?'PUT':'POST';
    const endpoint=method==='POST'?`${baseUrl}/api/bots/${botName}/tools`:`${baseUrl}/api/bots/${botName}/tools/${name}`;
    await fetch(endpoint,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(dto)});
    closeToolModal();
    loadToolsTable();
}
async function deleteTool(name){
    const botName=document.getElementById('toolsBotSelect').value;
    if(!confirm('Delete tool?'))return;
    await fetch(`${baseUrl}/api/bots/${botName}/tools/${name}`,{method:'DELETE'});
    loadToolsTable();
}
function jsonField(id){
    try{return JSON.parse(document.getElementById(id).value||'{}');}
    catch(e){alert(id+' must be valid JSON');throw e;}
}

/* ---------- KNOWLEDGE BASE ---------- */
async function loadKbData(){const bot=document.getElementById('kbBotSelect').value;document.getElementById('kbBotTitle').textContent=bot?`Bot: ${bot}`:'';const qtbody=document.querySelector('#qnaTable tbody');const ftbody=document.querySelector('#fileTable tbody');qtbody.innerHTML='';ftbody.innerHTML='';if(!bot)return;const res=await fetch(`${baseUrl}/api/bots/${bot}/kb`);if(!res.ok)return;const kb=await res.json(); // {qnas:[],fileDetails:[]}
    // QnAs
    kb.qnas.forEach((qna,idx)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${idx}</td><td>${qna.question}</td><td>${qna.answer}</td><td class='actions'></td>`;const actions=tr.querySelector('.actions');const e=document.createElement('button');e.textContent='‚úèÔ∏è';e.onclick=()=>openQnaModal(qna,idx);const d=document.createElement('button');d.textContent='üóëÔ∏è';d.className='danger';d.onclick=()=>deleteQna(idx);actions.append(e,d);qtbody.appendChild(tr);});
    // Files
    kb.fileDetails.forEach(fd=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${fd.fileName}</td><td class='actions'></td>`;const del=document.createElement('button');del.textContent='üóëÔ∏è';del.className='danger';del.onclick=()=>deleteKbFile(fd.fileId);tr.querySelector('.actions').append(del);ftbody.appendChild(tr);});
}
function openQnaModal(qna,index){document.getElementById('qnaModal').style.display='flex';if(qna){editMode=true;currentQnaIndex=index;document.getElementById('qnaModalTitle').textContent='Edit¬†QnA';document.getElementById('qnaQuestion').value=qna.question;document.getElementById('qnaAnswer').value=qna.answer;}else{editMode=false;currentQnaIndex=null;document.getElementById('qnaModalTitle').textContent='New¬†QnA';document.getElementById('qnaQuestion').value='';document.getElementById('qnaAnswer').value='';}}
function closeQnaModal(){document.getElementById('qnaModal').style.display='none'}
async function saveQna(){const bot=document.getElementById('kbBotSelect').value;if(!bot){alert('Select bot');return;}const q=document.getElementById('qnaQuestion').value.trim();const a=document.getElementById('qnaAnswer').value.trim();if(!q||!a){alert('Both question and answer required');return;}const dto={question:q,answer:a};const headers={'Content-Type':'application/json'};if(editMode){await fetch(`${baseUrl}/api/bots/${bot}/kb/qnas/${currentQnaIndex}`,{method:'PUT',headers,body:JSON.stringify(dto)});}else{await fetch(`${baseUrl}/api/bots/${bot}/kb/qnas`,{method:'POST',headers,body:JSON.stringify(dto)});}closeQnaModal();loadKbData();}
async function deleteQna(idx){const bot=document.getElementById('kbBotSelect').value;if(!confirm('Delete QnA?'))return;await fetch(`${baseUrl}/api/bots/${bot}/kb/qnas/${idx}`,{method:'DELETE'});loadKbData();}
async function uploadKbFile(){const bot=document.getElementById('kbBotSelect').value;const fileInput=document.getElementById('kbFileInput');if(!bot||!fileInput.files.length){alert('Select bot and choose file');return;}const fd=new FormData();fd.append('file',fileInput.files[0]);await fetch(`${baseUrl}/api/bots/${bot}/kb/files`,{method:'POST',body:fd});fileInput.value='';loadKbData();}
async function deleteKbFile(fileId){const bot=document.getElementById('kbBotSelect').value;if(!confirm('Delete file?'))return;await fetch(`${baseUrl}/api/bots/${bot}/kb/files/${fileId}`,{method:'DELETE'});loadKbData();}

// ---------- INIT ----------
loadBots();
</script>
</body>
</html>
